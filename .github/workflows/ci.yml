name: CI

on:
    push:
        branches-ignore: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    lint:
        name: Lint (Pint)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.3
                  tools: composer
                  coverage: none

            - name: Install dependencies
              run: composer install --no-interaction --prefer-dist

            - name: Check code style
              run: vendor/bin/pint --test

    analyse:
        name: Static Analysis (PHPStan)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.3
                  tools: composer
                  coverage: none

            - name: Install dependencies
              run: composer install --no-interaction --prefer-dist

            - name: Run PHPStan
              run: php -d memory_limit=1G vendor/bin/phpstan analyse

    test:
        name: Tests (PHP ${{ matrix.php }} | ${{ matrix.os }} | ${{ matrix.deps }})
        runs-on: ${{ matrix.os }}

        strategy:
            fail-fast: true
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                php: [8.3, 8.4, 8.5]
                deps: [prefer-lowest, prefer-stable]

        steps:
            - uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  extensions: dom, mbstring, zip, fileinfo
                  coverage: none
                  tools: composer

            - name: Install dependencies
              run: composer update --${{ matrix.deps }} --no-interaction --prefer-dist

            - name: Run tests
              run: vendor/bin/phpunit

    packagist:
        name: Packagist Validation
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.3
                  tools: composer
                  coverage: none

            - name: Validate composer.json
              run: composer validate --strict

            - name: Check autoloading
              run: composer dump-autoload --dry-run --optimize
