name: CI

on:
    push:
        branches-ignore: ["main"]
    pull_request:
        branches: ["main"]

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        name: Lint (Pint)
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.3
                  tools: composer
                  coverage: none

            - uses: actions/cache@v4
              with:
                  path: ~/.composer/cache
                  key: pint-${{ hashFiles('composer.lock') }}

            - run: composer install --no-interaction --prefer-dist
            - run: vendor/bin/pint --test

    analyse:
        name: Static Analysis (PHPStan)
        runs-on: ubuntu-latest
        needs: lint

        steps:
            - uses: actions/checkout@v4

            - uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.3
                  tools: composer
                  coverage: none

            - uses: actions/cache@v4
              with:
                  path: ~/.composer/cache
                  key: phpstan-${{ hashFiles('composer.lock') }}

            - run: composer install --no-interaction --prefer-dist
            - run: php -d memory_limit=1G vendor/bin/phpstan analyse

    test:
        name: Tests (PHP ${{ matrix.php }} | ${{ matrix.os }} | ${{ matrix.deps }})
        runs-on: ${{ matrix.os }}
        needs: analyse

        strategy:
            fail-fast: true
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                php: [8.3, 8.4]
                deps: [prefer-lowest, prefer-stable]

        steps:
            - uses: actions/checkout@v4

            - uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  extensions: dom, mbstring, zip, fileinfo
                  tools: composer
                  coverage: none

            - run: composer update --${{ matrix.deps }} --no-interaction --prefer-dist
            - run: vendor/bin/phpunit

    packagist:
        name: Composer / Packagist Validation
        runs-on: ubuntu-latest
        needs: lint

        steps:
            - uses: actions/checkout@v4

            - uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.3
                  tools: composer

            - run: composer validate --strict
            - run: composer dump-autoload --dry-run --optimize
